#!/bin/bash

# Change this to 0 if you do not wish to automatically download+install
# Beneath a Steel Sky.
# The game is freeware and grabbed from ScummVM's servers.

DOWNLOADBASS=1

# Get ourselves properly set up in the environment

TOP=$(cd `dirname "${BASH_SOURCE[0]}"` && pwd)
if [ "${MARVELL_SDK_PATH}" = "" ]; then
	MARVELL_SDK_PATH="$(cd "${TOP}/../.." && pwd)"
fi
if [ "${MARVELL_ROOTFS}" = "" ]; then
	source "${MARVELL_SDK_PATH}/setenv.sh" || exit 1
fi
cd "${TOP}"

LDFLAGS=-L"${MARVELL_ROOTFS}"/usr/lib

# Determine a decent value for make -j

NCPU=`cat /proc/cpuinfo |grep vendor_id |wc -l`
let NCPU=$NCPU+2

# Build ScummVM

./configure --host=steamlink "$@"
make -j $NCPU || exit 2

export DESTDIR="${PWD}/steamlink/apps/scummvm"
mkdir -p "${DESTDIR}"

# Download Beneath a Steel Sky for installation


if [ "${DOWNLOADBASS}" = "1" ]; then
	echo "Installing Beneath a Steel Sky."
	if [ ! -f bass-cd-1.2.zip ]; then
		echo "Downloading BASS from ScummVM.org"
		wget https://www.scummvm.org/frs/extras/Beneath%20a%20Steel%20Sky/bass-cd-1.2.zip
	else
		echo "Don't need to download - skipping to installation."
	fi
	echo "Unzipping and moving BASS to install directory."
	unzip bass-cd-1.2.zip
	mv bass-cd-1.2 "${DESTDIR}"/sky
else
	echo "Skipping BASS installation. Provide your own games via USB or SCP."
fi
	

cp -v scummvm "${DESTDIR}"

cat >"${DESTDIR}/toc.txt" <<__EOF__
name=ScummVM
icon=icon.png
run=scummvm.sh
__EOF__

cat >"${DESTDIR}/scummvm.sh" <<__EOF__
#!bin/bash
./scummvm --joystick=0
__EOF__

chmod +x "${DESTDIR}/scummvm.sh"

base64 -d >"${DESTDIR}/icon.png" <<__EOF__
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
KzAwOjAw2blJeAAAAABJRU5ErkJggg==
__EOF__

name=$(basename ${DESTDIR})
pushd "$(dirname ${DESTDIR})"
tar zcvf $name.tgz $name || exit 3
rm -rf $name
popd

echo "Build complete!"
echo
echo "Put the steamlink folder onto a USB drive, insert it into your Steam Link, and cycle the power to install."
echo "Or scp to your Steam Link to the /home/apps/scummvm directory."
